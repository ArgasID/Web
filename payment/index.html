<!DOCTYPE html>
<html lang="id">
<head>
  <meta name="theme-color" content="#121a3a" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0a0f2e" media="(prefers-color-scheme: dark)">
  <meta name="msapplication-navbutton-color" content="#121a3a">
  <meta name="apple-mobile-web-app-status-bar-style" content="#121a3a">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Pembayaran Rank - Glowbit Network</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="container">
    <section class="card">
      <h2><i class="fas fa-crown"></i> Pembayaran Rank</h2>
      
      <div class="rank-info">
        <p>Rank yang dipilih:</p>
        <h3 id="rank-name">-</h3>
        <p>Harga:</p>
        <h3 id="rank-price">-</h3>
      </div>

      <form id="payment-form">
        <label for="name">
          <i class="fas fa-user"></i> Nama Lengkap
        </label>
        <input type="text" id="name" placeholder="Masukkan nama lengkap" required>

        <label for="email">
          <i class="fas fa-envelope"></i> Email
        </label>
        <input type="email" id="email" placeholder="contoh@email.com" required>

        <label for="phone">
          <i class="fas fa-phone"></i> Nomor WhatsApp
        </label>
        <input type="tel" id="phone" placeholder="081234567890" required>

        <label for="payment-method">
          <i class="fas fa-wallet"></i> Metode Pembayaran
        </label>
        <select id="payment-method" required>
          <option value="">-- Pilih Metode --</option>
          <option value="QRIS">QRIS (Semua E-Wallet)</option>
          <option value="BNIVA">BNI Virtual Account</option>
          <option value="MANDIRIVA">Mandiri Virtual Account</option>
          <option value="BRIVA">BRI Virtual Account</option>
          <option value="OVO">OVO</option>
          <option value="DANA">DANA</option>
          <option value="SHOPEEPAY">ShopeePay</option>
        </select>

        <button type="submit" class="btn">
          <i class="fas fa-credit-card"></i> Bayar Sekarang
        </button>
      </form>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Ambil data dari localStorage
      const rank = localStorage.getItem("rank");
      let harga = localStorage.getItem("harga");

      // Pastikan harga berupa number
      harga = harga ? parseInt(harga) : 0;

      if (rank && harga) {
        document.getElementById("rank-name").textContent = rank;
        document.getElementById("rank-price").textContent = formatRupiah(harga);
      } else {
        alert("Data pembelian tidak valid. Silakan pilih rank kembali.");
        window.location.href = "/category/ranks/";
      }

      // Format harga ke Rupiah
      function formatRupiah(angka) {
        return "Rp" + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }
    });

    // Tangani form pembayaran
    document.getElementById("payment-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      const rank = localStorage.getItem("rank");
      const harga = localStorage.getItem("harga");
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const method = document.getElementById("payment-method").value;

      // Validasi
      if (!name || !email || !phone || !method) {
        alert("Harap lengkapi semua data!");
        return;
      }

      // Validasi nomor HP
      if (!/^[0-9]{10,13}$/.test(phone)) {
        alert("Nomor HP tidak valid! Harus 10-13 digit angka.");
        return;
      }

      // Validasi email
      if (!/^\S+@\S+\.\S+$/.test(email)) {
        alert("Format email tidak valid!");
        return;
      }

      try {
        // Tampilkan loading
        const btn = document.querySelector(".btn");
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
        btn.disabled = true;

        // Kirim data ke server
        const response = await fetch("/api/bayar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            rank,
            harga,
            name,
            email,
            phone,
            payment_method: method
          })
        });

        const result = await response.json();

        if (result.success && result.data?.checkout_url) {
          window.location.href = result.data.checkout_url;
        } else {
          alert(result.message || "Gagal memproses pembayaran");
          btn.innerHTML = '<i class="fas fa-credit-card"></i> Bayar Sekarang';
          btn.disabled = false;
        }
      } catch (error) {
        console.error("Error:", error);
        alert("Terjadi kesalahan saat memproses pembayaran");
        const btn = document.querySelector(".btn");
        btn.innerHTML = '<i class="fas fa-credit-card"></i> Bayar Sekarang';
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>