<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status Pembayaran</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <style>
    .status-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
    }
    .status-paid { color: #28a745; }
    .status-pending { color: #ffc107; }
    .status-failed, .status-expired { color: #dc3545; }
    .transaction-details {
      background-color: #f8f9fa;
      border-radius: 0.25rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body text-center p-4">
            <div id="status-icon" class="status-icon mb-3">⌛</div>
            <h2 id="status-title" class="mb-3">Memeriksa Status Pembayaran</h2>
            <p id="status-message" class="text-muted mb-4">Mohon tunggu sebentar...</p>
            
            <div id="transaction-details" class="transaction-details text-start" style="display: none;">
              <div class="row mb-2">
                <div class="col-4 fw-bold">ID Transaksi:</div>
                <div class="col-8" id="transaction-id"></div>
              </div>
              <div class="row mb-2">
                <div class="col-4 fw-bold">Username:</div>
                <div class="col-8" id="transaction-username"></div>
              </div>
              <div class="row mb-2">
                <div class="col-4 fw-bold">Rank:</div>
                <div class="col-8" id="transaction-rank"></div>
              </div>
              <div class="row mb-2">
                <div class="col-4 fw-bold">Jumlah:</div>
                <div class="col-8" id="transaction-amount"></div>
              </div>
              <div class="row mb-2">
                <div class="col-4 fw-bold">Metode Pembayaran:</div>
                <div class="col-8" id="transaction-method"></div>
              </div>
              <div class="row">
                <div class="col-4 fw-bold">Tanggal:</div>
                <div class="col-8" id="transaction-date"></div>
              </div>
            </div>
            
            <div id="button-container" class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-4"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const statusIcon = document.getElementById('status-icon');
      const statusTitle = document.getElementById('status-title');
      const statusMessage = document.getElementById('status-message');
      const buttonContainer = document.getElementById('button-container');
      const transactionDetails = document.getElementById('transaction-details');
      
      // Ambil transactionId dari localStorage
      const transactionId = localStorage.getItem('last_transaction');
      
      if (!transactionId) {
        showError('Tidak ada data transaksi terakhir. Silakan lakukan transaksi baru.');
        return;
      }

      try {
        // Tampilkan ID transaksi sementara
        statusMessage.textContent = `Memeriksa status transaksi: ${transactionId}`;
        
        // Cek status ke backend
        const response = await fetch(`/api/check-transaction?transaction_id=${encodeURIComponent(transactionId)}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();

        if (!result.success) {
          showError(result.message || 'Gagal memeriksa status transaksi');
          return;
        }

        // Tampilkan detail transaksi
        document.getElementById('transaction-id').textContent = transactionId;
        document.getElementById('transaction-username').textContent = result.data.detail.username;
        document.getElementById('transaction-rank').textContent = result.data.detail.rank;
        document.getElementById('transaction-amount').textContent = new Intl.NumberFormat('id-ID', {
          style: 'currency',
          currency: 'IDR'
        }).format(result.data.detail.jumlah);
        document.getElementById('transaction-method').textContent = result.data.detail.metode_pembayaran;
        document.getElementById('transaction-date').textContent = new Date(result.data.detail.tanggal).toLocaleString('id-ID');
        
        transactionDetails.style.display = 'block';

        // Update UI berdasarkan status
        updateUI(result.data.status, result.data.checkout_url, transactionId);

      } catch (error) {
        console.error('Error:', error);
        showError('Terjadi kesalahan saat memeriksa status pembayaran. Silakan coba lagi atau hubungi admin.');
      }
    });

    function updateUI(status, checkoutUrl, transactionId) {
      let icon, title, message, buttons;

      switch(status) {
        case 'PAID':
          icon = '✓';
          title = 'Pembayaran Berhasil!';
          message = 'Terima kasih! Pembayaran Anda telah berhasil diproses.';
          buttons = `
            <a href="/" class="btn btn-success px-4">Kembali ke Beranda</a>
          `;
          break;

        case 'PENDING':
          icon = '⌛';
          title = 'Menunggu Pembayaran';
          message = 'Silakan selesaikan pembayaran Anda untuk mengaktifkan rank.';
          buttons = `
            <a href="${checkoutUrl}" class="btn btn-primary px-4" target="_blank">Lanjutkan Pembayaran</a>
            <a href="/" class="btn btn-outline-secondary px-4">Kembali ke Beranda</a>
          `;
          break;

        case 'EXPIRED':
          icon = '✗';
          title = 'Pembayaran Kadaluarsa';
          message = 'Waktu pembayaran Anda telah habis. Silakan lakukan transaksi baru.';
          buttons = `
            <a href="/beli-rank" class="btn btn-primary px-4">Beli Rank Baru</a>
            <a href="/" class="btn btn-outline-secondary px-4">Kembali ke Beranda</a>
          `;
          break;

        case 'FAILED':
          icon = '✗';
          title = 'Pembayaran Gagal';
          message = 'Pembayaran Anda gagal diproses. Silakan coba lagi.';
          buttons = `
            <a href="${checkoutUrl}" class="btn btn-primary px-4" target="_blank">Coba Bayar Lagi</a>
            <a href="/" class="btn btn-outline-secondary px-4">Kembali ke Beranda</a>
          `;
          break;

        default:
          icon = '❓';
          title = 'Status Tidak Dikenali';
          message = `Status: ${status || 'tidak diketahui'}`;
          buttons = `
            <a href="/" class="btn btn-outline-secondary px-4">Kembali ke Beranda</a>
          `;
      }

      statusIcon.innerHTML = icon;
      statusIcon.className = `status-icon status-${status.toLowerCase()}`;
      statusTitle.textContent = title;
      statusMessage.textContent = message;
      buttonContainer.innerHTML = buttons;
    }

    function showError(message) {
      const statusIcon = document.getElementById('status-icon');
      const statusTitle = document.getElementById('status-title');
      const statusMessage = document.getElementById('status-message');
      const buttonContainer = document.getElementById('button-container');

      statusIcon.innerHTML = '❌';
      statusIcon.className = 'status-icon status-failed';
      statusTitle.textContent = 'Terjadi Kesalahan';
      statusMessage.textContent = message;
      buttonContainer.innerHTML = `
        <a href="/" class="btn btn-danger px-4">Kembali ke Beranda</a>
        <a href="/kontak" class="btn btn-outline-secondary px-4">Hubungi Admin</a>
      `;
    }
  </script>
</body>
</html>