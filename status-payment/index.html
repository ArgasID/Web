<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status Pembayaran</title>
  <link rel="stylesheet" href="status-payment.css">
</head>
<body>
  <div class="payment-container">
    <div id="status-icon" class="status-icon">⌛</div>
    <h1 id="status-title">Memeriksa Status Pembayaran</h1>
    <p id="status-message">Mohon tunggu...</p>
    <div id="button-container"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const statusIcon = document.getElementById('status-icon');
      const statusTitle = document.getElementById('status-title');
      const statusMessage = document.getElementById('status-message');
      const buttonContainer = document.getElementById('button-container');

      // Ambil transactionId dari localStorage
      const transactionId = localStorage.getItem('last_transaction');
      
      if (!transactionId) {
        showError('Transaksi tidak ditemukan');
        return;
      }

      try {
        // Cek status ke backend
        const response = await fetch(`/api/check-transaction/${transactionId}`);
        const result = await response.json();

        if (!result.success) {
          showError(result.message || 'Gagal memeriksa status');
          return;
        }

        const { status, checkout_url } = result.data;

        // Update UI berdasarkan status
        updateUI(status, checkout_url, transactionId);

      } catch (error) {
        console.error('Error:', error);
        showError('Terjadi kesalahan jaringan');
      }
    });

    function updateUI(status, checkoutUrl, transactionId) {
      let icon, title, message, buttons;

      switch(status) {
        case 'PAID':
          icon = '✓';
          title = 'Pembayaran Berhasil!';
          message = `Terima kasih. ID Transaksi: ${transactionId}`;
          buttons = `
            <a href="/" class="btn btn-primary">Kembali Ke Beranda</a>
          `;
          break;

        case 'PENDING':
          icon = '⌛';
          title = 'Menunggu Pembayaran';
          message = `Silakan selesaikan pembayaran. ID: ${transactionId}`;
          buttons = `
            <a href="${checkoutUrl}" class="btn btn-primary">Lanjutkan Pembayaran</a>
            <a href="/" class="btn btn-secondary">Kembali Ke Beranda</a>
          `;
          break;

        case 'EXPIRED':
        case 'FAILED':
          icon = '✗';
          title = status === 'EXPIRED' ? 'Pembayaran Kadaluarsa' : 'Pembayaran Gagal';
          message = `ID Transaksi: ${transactionId}`;
          buttons = `
            <a href="/" class="btn btn-danger">Kembali Ke Beranda</a>
          `;
          break;

        default:
          icon = '❓';
          title = 'Status Tidak Dikenali';
          message = `Status: ${status || 'unknown'}`;
          buttons = `
            <a href="/" class="btn btn-secondary">Kembali Ke Beranda</a>
          `;
      }

      statusIcon.innerHTML = icon;
      statusIcon.className = `status-icon ${status.toLowerCase()}`;
      statusTitle.textContent = title;
      statusMessage.textContent = message;
      buttonContainer.innerHTML = buttons;
    }

    function showError(message) {
      statusIcon.innerHTML = '❌';
      statusIcon.className = 'status-icon failed';
      statusTitle.textContent = 'Error';
      statusMessage.textContent = message;
      buttonContainer.innerHTML = `
        <a href="/" class="btn btn-danger">Kembali Ke Beranda</a>
      `;
    }
  </script>
</body>
</html>